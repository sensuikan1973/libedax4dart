name: unit_test

on:
  pull_request:
    paths: ['**.dart', 'pubspec.*', '.github/workflows/unit_test.yaml', 'scripts/build_libedax.sh']
  push:
    branches: [ main ]
    paths: ['**.dart', 'pubspec.*', '.github/workflows/unit_test.yaml', 'scripts/build_libedax.sh']

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    steps:
    - uses: actions/checkout@v2

    - uses: cedx/setup-dart@v2
      with:
        architecture: x64
        release-channel: beta

    - name: cache libedax assets for test
      id: cache-libedax-assets
      uses: actions/cache@v2
      with:
        path: |
          libedax.so
          data
        key: ${{ runner.os }}-libedax-assets-${{ hashFiles('libedax.so', 'data/*.dat') }}

    - name: build libedax
      if: steps.cache-libedax-assets.outputs.cache-hit != 'true'
      env:
        dst: '.'
        libedax_build_command: make libbuild ARCH=x64-modern COMP=gcc OS=linux
      run: sh scripts/build_libedax.sh
    - name: mv libedax.so for pub test
      if: steps.cache-libedax-assets.outputs.cache-hit != 'true'
      run: mv bin/libedax.so ./libedax.so && ls

    # DEBUG
    - name: setup tmate session for debug ssh
      uses: mxschmitt/action-tmate@v3

    - name: install dependencies
      run: pub get
    - name: test
      run: pub run test .
